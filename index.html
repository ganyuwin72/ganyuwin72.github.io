<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>任务管理与计时统计</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 16px;
    }
    h1 {
      text-align: center;
      margin-bottom: 32px;
      color: #222;
    }
    .task-board {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      justify-content: flex-start;
    }
    .task-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      padding: 24px;
      width: 370px;
      min-width: 260px;
      max-width: 100%;
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
      cursor: grab;
      user-select: none;
    }
    .task-card.dragging {
      opacity: 0.5;
    }
    .task-title {
      font-size: 1.2em;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .task-meta {
      font-size: 0.95em;
      color: #888;
      margin-bottom: 8px;
    }
    .progress-bar {
      background: #eee;
      border-radius: 8px;
      height: 14px;
      width: 100%;
      margin-bottom: 8px;
      overflow: hidden;
    }
    .progress-bar-inner {
      background: linear-gradient(90deg, #4ecca3, #3aafa9);
      height: 100%;
      width: 0%;
      transition: width 0.4s;
    }
    .subtasks {
      margin-left: 0;
      padding-left: 0;
      list-style: none;
    }
    .subtask {
      margin-bottom: 8px;
      padding-left: 0;
      cursor: grab;
      user-select: none;
    }
    .subtask.dragging {
      opacity: 0.5;
    }
    .subtask-level-1 { margin-left: 0; background: #e0f7fa; border-radius: 6px; }
    .subtask-level-2 { margin-left: 16px; background: #f1f8e9; border-radius: 6px; }
    .subtask-level-3 { margin-left: 32px; background: #f9fbe7; border-radius: 6px; }
    .subtask-level-1 { color: #00796b; }
    .subtask-level-2 { color: #689f38; }
    .subtask-level-3 { color: #bdb76b; }
    .subtask-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
    }
    .btn {
      background: #3aafa9;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 4px 12px;
      cursor: pointer;
      font-size: 0.95em;
      transition: background 0.2s;
    }
    .btn:active {
      background: #2b7a78;
    }
    .btn-small {
      font-size: 0.85em;
      padding: 2px 8px;
    }
    .add-task-btn {
      display: block;
      margin: 0 auto 32px auto;
      background: #4ecca3;
      font-weight: 700;
      font-size: 1.1em;
    }
    .heatmap {
      display: grid;
      grid-template-columns: repeat(53, 10px);
      gap: 1px;
      margin-top: 8px;
      width: 560px;
      max-width: 100%;
      overflow-x: auto;
    }
    .heatmap-day {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      background: #e0e0e0;
      transition: background 0.2s;
      box-sizing: border-box;
      border: 1px solid #f5f6fa;
    }
    .heatmap-day.done {
      background: #3aafa9;
    }
    .heatmap-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.8em;
      color: #888;
      margin-top: 2px;
    }
    .habit-label {
      font-size: 0.95em;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .habit-board {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      justify-content: flex-start;
    }
    .habit-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      padding: 20px;
      width: 320px;
      min-width: 260px;
      max-width: 100%;
      margin: 0 12px 24px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      cursor: grab;
      user-select: none;
    }
    .habit-card.dragging {
      opacity: 0.5;
    }
    .habit-controls {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }
    .habit-controls .btn {
      background: #4ecca3;
    }
    .habit-controls .btn:active {
      background: #2b7a78;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.25);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #fff;
      padding: 32px 24px;
      border-radius: 12px;
      min-width: 320px;
      max-width: 90vw;
    }
    .modal-content input {
      margin-bottom: 8px;
    }
    .password-modal {
      display: flex;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.25);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    .password-modal-content {
      background: #fff;
      padding: 32px 24px;
      border-radius: 12px;
      min-width: 320px;
      max-width: 90vw;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .password-modal-content input {
      font-size: 1.1em;
      padding: 6px 12px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 200px;
      text-align: center;
    }
    .password-modal-content .btn {
      width: 100%;
    }
    .password-error {
      color: #e74c3c;
      margin-bottom: 8px;
      font-size: 0.98em;
    }
    .date-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.25);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }
    .date-modal-content {
      background: #fff;
      padding: 24px 20px;
      border-radius: 12px;
      min-width: 220px;
      max-width: 90vw;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .date-modal-content input[type="date"] {
      font-size: 1em;
      padding: 4px 8px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div id="password-modal" class="password-modal" style="display:none;">
    <div class="password-modal-content">
      <div style="font-size:1.1em;margin-bottom:8px;">请输入访问密码</div>
      <input id="password-input" type="password" placeholder="密码" autocomplete="off" onkeydown="if(event.key==='Enter'){checkPassword();}">
      <div id="password-error" class="password-error" style="display:none;"></div>
      <button class="btn" onclick="checkPassword()">进入</button>
    </div>
  </div>
  <div id="main-app" style="display:none;">
    <div class="container">
      <h1>任务管理与计时统计</h1>
      <button class="btn add-task-btn" onclick="showTaskForm()">+ 新建任务</button>
      <div id="task-board" class="task-board"></div>
      <h2 style="margin-top:40px;">每日习惯</h2>
      <button class="btn add-task-btn" style="margin-bottom:16px;" onclick="showHabitForm()">+ 新建习惯</button>
      <div id="habit-board" class="habit-board"></div>
      <!-- 任务表单弹窗 -->
      <div id="task-form-modal" class="modal">
        <div class="modal-content">
          <h3>新建任务</h3>
          <label>任务名称：<input id="task-title-input" style="width:90%"></label><br>
          <label>预计完成时间（小时）：<input id="task-estimate-input" type="number" min="0" style="width:60px;"></label><br>
          <button class="btn" onclick="addTask()">添加</button>
          <button class="btn btn-small" onclick="hideTaskForm()">取消</button>
        </div>
      </div>
      <!-- 习惯表单弹窗 -->
      <div id="habit-form-modal" class="modal">
        <div class="modal-content">
          <h3>新建习惯</h3>
          <label>习惯名称：<input id="habit-title-input" style="width:90%"></label><br>
          <button class="btn" onclick="addHabit()">添加</button>
          <button class="btn btn-small" onclick="hideHabitForm()">取消</button>
        </div>
      </div>
      <!-- 补录日期弹窗 -->
      <div id="date-modal" class="date-modal">
        <div class="date-modal-content">
          <div style="font-size:1.05em;margin-bottom:8px;">选择补录日期</div>
          <input id="date-input" type="date">
          <button class="btn" onclick="confirmDateModal()">补录</button>
          <button class="btn btn-small" onclick="hideDateModal()">取消</button>
        </div>
      </div>
      <!-- 计时弹窗 -->
      <div id="timer-modal" class="modal" style="display:none;z-index:4000;">
        <div class="modal-content" style="min-width:200px;text-align:center;">
          <h3>计时中</h3>
          <div id="timer-modal-time" style="font-size:2em;margin:16px 0;">00:00</div>
          <button class="btn" onclick="stopTimerModal(true)">完成并累计</button>
          <button class="btn btn-small" onclick="stopTimerModal(false)">取消</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    const SITE_PASSWORD = 'ganyuwindrso72';
    let tasks = [];
    let habits = [];
    let timers = {};
    let dateModalHabitId = null;
    let dragInfo = { type: null, from: null, to: null, parent: null };
    let timerRenderInterval = null;
    let timerModalTaskId = null, timerModalSubId = null, timerModalInterval = null, timerModalSeconds = 0;

    function saveTasks() { localStorage.setItem('tasks', JSON.stringify(tasks)); }
    function saveHabits() { localStorage.setItem('habits', JSON.stringify(habits)); }
    function formatTime(sec) {
      const h = Math.floor(sec/3600);
      const m = Math.floor((sec%3600)/60);
      const s = sec%60;
      return `${h>0?h+':':''}${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }
    function getTodayStr() {
      const d = new Date();
      return d.toISOString().slice(0,10);
    }
    function getTotalTimeSpent(subtasks) {
      let total = 0;
      for (let s of subtasks) {
        if (s.subtasks && s.subtasks.length>0) {
          total += getTotalTimeSpent(s.subtasks);
        }
        total += s.timeSpent||0;
      }
      return total;
    }
    function showPasswordModal() {
      document.getElementById('password-modal').style.display = 'flex';
      document.getElementById('main-app').style.display = 'none';
      setTimeout(() => {
        document.getElementById('password-input').focus();
      }, 100);
    }
    function hidePasswordModal() {
      document.getElementById('password-modal').style.display = 'none';
      document.getElementById('main-app').style.display = '';
    }
    function checkPassword() {
      const input = document.getElementById('password-input').value;
      if (input === SITE_PASSWORD) {
        localStorage.setItem('site_authed', '1');
        hidePasswordModal();
        tasks = JSON.parse(localStorage.getItem('tasks')||'[]');
        habits = JSON.parse(localStorage.getItem('habits')||'[]');
        renderTasks();
        renderHabits();
      } else {
        document.getElementById('password-error').innerText = '密码错误，请重试';
        document.getElementById('password-error').style.display = 'block';
      }
    }
    function showTaskForm() {
      document.getElementById('task-form-modal').style.display = 'flex';
    }
    function hideTaskForm() {
      document.getElementById('task-form-modal').style.display = 'none';
      document.getElementById('task-title-input').value = '';
      document.getElementById('task-estimate-input').value = '';
    }
    function addTask() {
      const title = document.getElementById('task-title-input').value.trim();
      const estimate = Number(document.getElementById('task-estimate-input').value);
      if (!title) return alert('请输入任务名称');
      tasks.push({
        id: 'task_'+Date.now(),
        title,
        estimate: estimate||0,
        subtasks: [],
        timeSpent: 0
      });
      saveTasks();
      tasks = JSON.parse(localStorage.getItem('tasks')||'[]');
      hideTaskForm();
      renderTasks();
    }
    function addSubtask(taskId, parentId, level) {
      const name = prompt('子任务名称：');
      if (!name) return;
      let task = tasks.find(t=>t.id===taskId);
      let parent = task;
      if (parentId) {
        function findSub(subs, id) {
          for (let s of subs) {
            if (s.id===id) return s;
            if (s.subtasks) {
              const found = findSub(s.subtasks, id);
              if (found) return found;
            }
          }
        }
        parent = findSub(task.subtasks, parentId);
      }
      if (!parent.subtasks) parent.subtasks = [];
      if (level>=3) return alert('最多三级分解');
      parent.subtasks.push({
        id: 'sub_'+Date.now()+Math.random(),
        name,
        subtasks: [],
        timeSpent: 0,
        running: false,
        done: false
      });
      saveTasks();
      tasks = JSON.parse(localStorage.getItem('tasks')||'[]');
      renderTasks();
    }
    function findSubtaskById(subtasks, id) {
      for (let s of subtasks) {
        if (s.id===id) return s;
        if (s.subtasks) {
          const found = findSubtaskById(s.subtasks, id);
          if (found) return found;
        }
      }
    }
    function startTimer(taskId, subId) {
      let task = tasks.find(t=>t.id===taskId);
      let sub = findSubtaskById(task.subtasks, subId);
      if (sub.running) return;
      sub.running = true;
      if (!timers[subId]) {
        timers[subId] = setInterval(()=>{
          sub.timeSpent = (sub.timeSpent||0)+1;
          saveTasks();
          tasks = JSON.parse(localStorage.getItem('tasks')||'[]');
          renderTasks();
        }, 1000);
      }
      saveTasks();
      tasks = JSON.parse(localStorage.getItem('tasks')||'[]');
      renderTasks();
    }
    function stopTimer(taskId, subId) {
      let task = tasks.find(t=>t.id===taskId);
      let sub = findSubtaskById(task.subtasks, subId);
      if (!sub.running) return;
      sub.running = false;
      if (timers[subId]) {
        clearInterval(timers[subId]);
        timers[subId] = null;
      }
      saveTasks();
      tasks = JSON.parse(localStorage.getItem('tasks')||'[]');
      renderTasks();
    }
    function markDone(taskId, subId) {
      let task = tasks.find(t=>t.id===taskId);
      let sub = findSubtaskById(task.subtasks, subId);
      sub.done = true;
      sub.running = false;
      if (timers[subId]) {
        clearInterval(timers[subId]);
        timers[subId] = null;
      }
      saveTasks();
      tasks = JSON.parse(localStorage.getItem('tasks')||'[]');
      renderTasks();
    }
    function renderTasks() {
      tasks = JSON.parse(localStorage.getItem('tasks')||'[]');
      const board = document.getElementById('task-board');
      board.innerHTML = '';
      tasks.forEach((task, idx) => {
        const card = document.createElement('div');
        card.className = 'task-card';
        card.setAttribute('draggable','true');
        card.ondragstart = e=>taskDragStart(e, idx);
        card.ondragover = e=>taskDragOver(e, idx);
        card.ondrop = e=>taskDrop(e, idx);
        card.ondragend = ()=>card.classList.remove('dragging');
        let totalLeaf = 0, doneLeaf = 0;
        function countLeafs(subs) {
          let count = 0;
          for (let s of subs) {
            if (s.subtasks && s.subtasks.length>0) {
              count += countLeafs(s.subtasks);
            } else {
              count++;
              if (s.done) doneLeaf++;
            }
          }
          return count;
        }
        totalLeaf = countLeafs(task.subtasks);
        let percent = totalLeaf?Math.round(doneLeaf/totalLeaf*100):0;
        let totalTimeSpent = getTotalTimeSpent(task.subtasks);
        totalTimeSpent += task.timeSpent||0;
        card.innerHTML = `
          <div class="task-title" style="${percent===100?'color:#aaa;':''}">${task.title}</div>
          <div class="task-meta">预计用时: ${task.estimate||'-'} 小时 | 已用: ${formatTime(totalTimeSpent)}</div>
          <div class="progress-bar"><div class="progress-bar-inner" style="width:${percent}%;"></div></div>
          <div style="font-size:0.95em;">完成度: ${percent}%</div>
          <ul class="subtasks"></ul>
          <button class="btn btn-small" onclick="addSubtask('${task.id}',null,1)">+ 添加一级子任务</button>
          <button class="btn btn-small" onclick="deleteTask('${task.id}')">删除任务</button>
          <button class="btn btn-small" onclick="restoreTask('${task.id}')">复原全部子任务</button>
        `;
        function renderSubtasks(ul, subs, level, parentTaskId) {
          subs.forEach((sub, subIdx) => {
            const li = document.createElement('li');
            li.className = `subtask subtask-level-${level}`;
            li.setAttribute('draggable','true');
            li.ondragstart = e=>subtaskDragStart(e, subIdx, subs);
            li.ondragover = e=>subtaskDragOver(e, subIdx);
            li.ondrop = e=>subtaskDrop(e, subIdx, subs);
            li.ondragend = ()=>li.classList.remove('dragging');
            let leaf = (!sub.subtasks || sub.subtasks.length===0);
            let subTotalTime = getTotalTimeSpent(sub.subtasks||[])+(sub.timeSpent||0);
            let gray = sub.done?"color:#aaa;background:#eee;":"";
            li.innerHTML = `
              <span style="${sub.done?'text-decoration:line-through;color:#aaa;':''}">${sub.name}</span>
              ${leaf?`<span style='color:#888;font-size:0.9em;'> | 已用: ${formatTime(subTotalTime)}</span>`:''}
              <div class="subtask-controls">
                ${level<3?`<button class='btn btn-small' onclick=\"addSubtask('${task.id}','${sub.id}',${level+1})\">+ 子任务</button>`:''}
                ${leaf?`
                  <button class='btn btn-small' onclick=\"showTimerModal('${task.id}','${sub.id}')\" ${sub.done?'disabled':''}>计时</button>
                  <button class='btn btn-small' onclick=\"markDone('${task.id}','${sub.id}')\" ${sub.done?'disabled':''}>完成</button>
                  <button class='btn btn-small' onclick=\"restoreSubtask('${task.id}','${sub.id}')\" ${!sub.done?'disabled':''}>复原</button>
                  <button class='btn btn-small' onclick=\"deleteSubtask('${task.id}','${sub.id}')\">删除</button>
                `:''}
              </div>
            `;
            if(sub.done) li.style.color = '#aaa';
            ul.appendChild(li);
            if (sub.subtasks && sub.subtasks.length>0) {
              const subUl = document.createElement('ul');
              subUl.className = 'subtasks';
              renderSubtasks(subUl, sub.subtasks, level+1, parentTaskId);
              ul.appendChild(subUl);
            }
          });
        }
        renderSubtasks(card.querySelector('.subtasks'), task.subtasks, 1, task.id);
        board.appendChild(card);
      });
      ensureTimerRender();
    }
    function renderHabits() {
      habits = JSON.parse(localStorage.getItem('habits')||'[]');
      const board = document.getElementById('habit-board');
      board.innerHTML = '';
      habits.forEach((habit, idx) => {
        const card = document.createElement('div');
        card.className = 'habit-card';
        card.setAttribute('draggable','true');
        card.ondragstart = e=>habitDragStart(e, idx);
        card.ondragover = e=>habitDragOver(e, idx);
        card.ondrop = e=>habitDrop(e, idx);
        card.ondragend = ()=>card.classList.remove('dragging');
        card.innerHTML = `<div class='habit-label'>${habit.title}</div>`;
        const controls = document.createElement('div');
        controls.className = 'habit-controls';
        controls.innerHTML = `
          <button class='btn btn-small' onclick="toggleHabitDone('${habit.id}','${getTodayStr()}')">今日打卡</button>
          <button class='btn btn-small' onclick="showDateModal('${habit.id}')">补录打卡</button>
          <button class='btn btn-small' onclick="deleteHabit('${habit.id}')">删除习惯</button>
        `;
        card.appendChild(controls);
        const today = new Date();
        let days = [];
        let start = new Date(today.getFullYear(),0,1);
        for (let i=0;i<365;i++) {
          let d = new Date(start.getTime()+i*24*3600*1000);
          if (d>today) break;
          days.push(d.toISOString().slice(0,10));
        }
        while (days.length<14*26) days.push('');
        const heatmap = document.createElement('div');
        heatmap.className = 'heatmap';
        heatmap.style.display = 'grid';
        heatmap.style.gridTemplateColumns = 'repeat(26, 10px)';
        heatmap.style.gridTemplateRows = 'repeat(14, 10px)';
        for (let row=0;row<14;row++) {
          for (let col=0;col<26;col++) {
            let idx = col*14+row;
            let dateStr = days[idx];
            const dayDiv = document.createElement('div');
            dayDiv.className = 'heatmap-day'+(dateStr&&habit.days[dateStr]?' done':'');
            dayDiv.title = dateStr||'';
            if (dateStr) dayDiv.onclick = ()=>toggleHabitDone(habit.id, dateStr);
            heatmap.appendChild(dayDiv);
          }
          if (row===6) {
            const sep = document.createElement('div');
            sep.style.gridColumn = '1 / span 26';
            sep.style.height = '2px';
            sep.style.background = '#bbb';
            sep.style.margin = '2px 0';
            sep.style.gridRow = (row+1);
            heatmap.appendChild(sep);
          }
        }
        card.appendChild(heatmap);
        const labels = document.createElement('div');
        labels.className = 'heatmap-labels';
        labels.innerHTML = '<span>1月</span><span>12月</span>';
        card.appendChild(labels);
        board.appendChild(card);
      });
      ensureTimerRender();
    }
    function taskDragStart(e, idx) {
      dragInfo = { type: 'task', from: idx, to: null };
      e.currentTarget.classList.add('dragging');
    }
    function taskDragOver(e, idx) {
      e.preventDefault();
      dragInfo.to = idx;
    }
    function taskDrop(e, idx) {
      e.preventDefault();
      if (dragInfo.type==='task' && dragInfo.from!==null && dragInfo.to!==null && dragInfo.from!==dragInfo.to) {
        const moved = tasks.splice(dragInfo.from,1)[0];
        tasks.splice(dragInfo.to,0,moved);
        saveTasks();
        tasks = JSON.parse(localStorage.getItem('tasks')||'[]');
        renderTasks();
      }
      document.querySelectorAll('.task-card').forEach(card=>card.classList.remove('dragging'));
      dragInfo = { type: null, from: null, to: null };
    }
    function subtaskDragStart(e, idx, parentSubs) {
      dragInfo = { type: 'subtask', from: idx, to: null, parent: parentSubs };
      e.currentTarget.classList.add('dragging');
    }
    function subtaskDragOver(e, idx) {
      e.preventDefault();
      dragInfo.to = idx;
    }
    function subtaskDrop(e, idx, parentSubs) {
      e.preventDefault();
      if (dragInfo.type==='subtask' && dragInfo.from!==null && dragInfo.to!==null && dragInfo.from!==dragInfo.to && dragInfo.parent===parentSubs) {
        const moved = parentSubs.splice(dragInfo.from,1)[0];
        parentSubs.splice(dragInfo.to,0,moved);
        saveTasks();
        tasks = JSON.parse(localStorage.getItem('tasks')||'[]');
        renderTasks();
      }
      document.querySelectorAll('.subtask').forEach(card=>card.classList.remove('dragging'));
      dragInfo = { type: null, from: null, to: null, parent: null };
    }
    function ensureTimerRender() {
      if (timerRenderInterval) clearInterval(timerRenderInterval);
      function hasRunning(subs) {
        for (let s of subs) {
          if (s.running) return true;
          if (s.subtasks && s.subtasks.length>0 && hasRunning(s.subtasks)) return true;
        }
        return false;
      }
      if (tasks.some(t=>hasRunning(t.subtasks))) {
        timerRenderInterval = setInterval(renderTasks, 1000);
      }
    }
    function showHabitForm() {
      document.getElementById('habit-form-modal').style.display = 'flex';
    }
    function hideHabitForm() {
      document.getElementById('habit-form-modal').style.display = 'none';
      document.getElementById('habit-title-input').value = '';
    }
    function addHabit() {
      const title = document.getElementById('habit-title-input').value.trim();
      if (!title) return alert('请输入习惯名称');
      habits.push({
        id: 'habit_'+Date.now(),
        title,
        days: {}
      });
      saveHabits();
      habits = JSON.parse(localStorage.getItem('habits')||'[]');
      hideHabitForm();
      renderHabits();
    }
    function toggleHabitDone(habitId, dateStr) {
      const habit = habits.find(h=>h.id===habitId);
      if (!habit.days) habit.days = {};
      habit.days[dateStr] = !habit.days[dateStr];
      saveHabits();
      habits = JSON.parse(localStorage.getItem('habits')||'[]');
      renderHabits();
    }
    function showDateModal(habitId) {
      dateModalHabitId = habitId;
      document.getElementById('date-modal').style.display = 'flex';
      document.getElementById('date-input').value = '';
    }
    function hideDateModal() {
      document.getElementById('date-modal').style.display = 'none';
      dateModalHabitId = null;
    }
    function confirmDateModal() {
      const dateStr = document.getElementById('date-input').value;
      if (!dateStr) return alert('请选择日期');
      const habit = habits.find(h=>h.id===dateModalHabitId);
      if (!habit.days) habit.days = {};
      habit.days[dateStr] = true;
      saveHabits();
      habits = JSON.parse(localStorage.getItem('habits')||'[]');
      hideDateModal();
      renderHabits();
    }
    function showTimerModal(taskId, subId) {
      timerModalTaskId = taskId;
      timerModalSubId = subId;
      timerModalSeconds = 0;
      document.getElementById('timer-modal').style.display = 'flex';
      document.getElementById('timer-modal-time').innerText = '00:00';
      if (timerModalInterval) clearInterval(timerModalInterval);
      timerModalInterval = setInterval(() => {
        timerModalSeconds++;
        let m = Math.floor(timerModalSeconds/60).toString().padStart(2,'0');
        let s = (timerModalSeconds%60).toString().padStart(2,'0');
        document.getElementById('timer-modal-time').innerText = `${m}:${s}`;
      }, 1000);
    }
    function stopTimerModal(save) {
      if (timerModalInterval) clearInterval(timerModalInterval);
      document.getElementById('timer-modal').style.display = 'none';
      if (save && timerModalTaskId && timerModalSubId) {
        let task = tasks.find(t=>t.id===timerModalTaskId);
        let sub = findSubtaskById(task.subtasks, timerModalSubId);
        sub.timeSpent = (sub.timeSpent||0) + timerModalSeconds;
        saveTasks();
        renderTasks();
      }
      timerModalTaskId = null;
      timerModalSubId = null;
      timerModalSeconds = 0;
    }
    function deleteTask(taskId) {
      tasks = tasks.filter(t=>t.id!==taskId);
      saveTasks();
      renderTasks();
    }
    function restoreTask(taskId) {
      let task = tasks.find(t=>t.id===taskId);
      task.timeSpent = 0;
      task.subtasks.forEach(sub=>{
        sub.timeSpent = 0;
        sub.done = false;
        sub.running = false;
      });
      saveTasks();
      renderTasks();
    }
    function deleteSubtask(taskId, subId) {
      let task = tasks.find(t=>t.id===taskId);
      function removeSubtask(subs, id) {
        for (let i = 0; i < subs.length; i++) {
          if (subs[i].id === id) { subs.splice(i, 1); return true; }
          if (subs[i].subtasks && removeSubtask(subs[i].subtasks, id)) return true;
        }
        return false;
      }
      removeSubtask(task.subtasks, subId);
      saveTasks();
      renderTasks();
    }
    function restoreSubtask(taskId, subId) {
      let task = tasks.find(t=>t.id===taskId);
      let sub = findSubtaskById(task.subtasks, subId);
      sub.done = false;
      sub.running = false;
      saveTasks();
      renderTasks();
    }
    function deleteHabit(habitId) {
      habits = habits.filter(h=>h.id!==habitId);
      saveHabits();
      renderHabits();
    }
    window.onload = function() {
      if (localStorage.getItem('site_authed') === '1') {
        document.getElementById('main-app').style.display = '';
        tasks = JSON.parse(localStorage.getItem('tasks')||'[]');
        habits = JSON.parse(localStorage.getItem('habits')||'[]');
        renderTasks();
        renderHabits();
      } else {
        showPasswordModal();
      }
    }
  </script>
</body>
</html>
