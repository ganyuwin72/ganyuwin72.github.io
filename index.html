<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>任务管理与计时统计</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 16px;
    }
    h1 {
      text-align: center;
      margin-bottom: 32px;
      color: #222;
    }
    .task-board {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      justify-content: center;
    }
    .task-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      padding: 24px;
      width: 370px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
    }
    .task-title {
      font-size: 1.2em;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .task-meta {
      font-size: 0.95em;
      color: #888;
      margin-bottom: 8px;
    }
    .progress-bar {
      background: #eee;
      border-radius: 8px;
      height: 14px;
      width: 100%;
      margin-bottom: 8px;
      overflow: hidden;
    }
    .progress-bar-inner {
      background: linear-gradient(90deg, #4ecca3, #3aafa9);
      height: 100%;
      width: 0%;
      transition: width 0.4s;
    }
    .subtasks {
      margin-left: 0;
      padding-left: 0;
      list-style: none;
    }
    .subtask {
      margin-bottom: 8px;
      padding-left: 0;
    }
    .subtask-level-1 { margin-left: 0; background: #e0f7fa; border-radius: 6px; }
    .subtask-level-2 { margin-left: 16px; background: #f1f8e9; border-radius: 6px; }
    .subtask-level-3 { margin-left: 32px; background: #f9fbe7; border-radius: 6px; }
    .subtask-level-1 { color: #00796b; }
    .subtask-level-2 { color: #689f38; }
    .subtask-level-3 { color: #bdb76b; }
    .subtask-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
    }
    .btn {
      background: #3aafa9;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 4px 12px;
      cursor: pointer;
      font-size: 0.95em;
      transition: background 0.2s;
    }
    .btn:active {
      background: #2b7a78;
    }
    .btn-small {
      font-size: 0.85em;
      padding: 2px 8px;
    }
    .add-task-btn {
      display: block;
      margin: 0 auto 32px auto;
      background: #4ecca3;
      font-weight: 700;
      font-size: 1.1em;
    }
    .heatmap {
      display: grid;
      grid-template-columns: repeat(53, 10px);
      gap: 1px;
      margin-top: 8px;
      width: 560px;
      max-width: 100%;
      overflow-x: auto;
    }
    .heatmap-day {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      background: #e0e0e0;
      transition: background 0.2s;
      box-sizing: border-box;
      border: 1px solid #f5f6fa;
    }
    .heatmap-day.done {
      background: #3aafa9;
    }
    .heatmap-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.8em;
      color: #888;
      margin-top: 2px;
    }
    .habit-label {
      font-size: 0.95em;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .habit-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      padding: 20px;
      width: 600px;
      margin: 0 12px 24px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .habit-controls {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }
    .habit-controls .btn {
      background: #4ecca3;
    }
    .habit-controls .btn:active {
      background: #2b7a78;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.25);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #fff;
      padding: 32px 24px;
      border-radius: 12px;
      min-width: 320px;
      max-width: 90vw;
    }
    .modal-content input {
      margin-bottom: 8px;
    }
    .password-modal {
      display: flex;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.25);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    .password-modal-content {
      background: #fff;
      padding: 32px 24px;
      border-radius: 12px;
      min-width: 320px;
      max-width: 90vw;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .password-modal-content input {
      font-size: 1.1em;
      padding: 6px 12px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 200px;
      text-align: center;
    }
    .password-modal-content .btn {
      width: 100%;
    }
    .password-error {
      color: #e74c3c;
      margin-bottom: 8px;
      font-size: 0.98em;
    }
    .date-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.25);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }
    .date-modal-content {
      background: #fff;
      padding: 24px 20px;
      border-radius: 12px;
      min-width: 220px;
      max-width: 90vw;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .date-modal-content input[type="date"] {
      font-size: 1em;
      padding: 4px 8px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div id="password-modal" class="password-modal" style="display:none;">
    <div class="password-modal-content">
      <div style="font-size:1.1em;margin-bottom:8px;">请输入访问密码</div>
      <input id="password-input" type="password" placeholder="密码" autocomplete="off" onkeydown="if(event.key==='Enter'){checkPassword();}">
      <div id="password-error" class="password-error" style="display:none;"></div>
      <button class="btn" onclick="checkPassword()">进入</button>
    </div>
  </div>
  <div id="main-app" style="display:none;">
    <div class="container">
      <h1>任务管理与计时统计</h1>
      <button class="btn add-task-btn" onclick="showTaskForm()">+ 新建任务</button>
      <div id="task-board" class="task-board"></div>
      <h2 style="margin-top:40px;">每日习惯</h2>
      <div id="habit-board" style="display:flex;flex-wrap:wrap;gap:24px;"></div>
      <!-- 任务表单弹窗 -->
      <div id="task-form-modal" class="modal">
        <div class="modal-content">
          <h3>新建任务</h3>
          <label>任务名称：<input id="task-title-input" style="width:90%"></label><br>
          <label>预计完成时间（小时）：<input id="task-estimate-input" type="number" min="0" style="width:60px;"></label><br>
          <button class="btn" onclick="addTask()">添加</button>
          <button class="btn btn-small" onclick="hideTaskForm()">取消</button>
        </div>
      </div>
      <!-- 习惯表单弹窗 -->
      <div id="habit-form-modal" class="modal">
        <div class="modal-content">
          <h3>新建习惯</h3>
          <label>习惯名称：<input id="habit-title-input" style="width:90%"></label><br>
          <button class="btn" onclick="addHabit()">添加</button>
          <button class="btn btn-small" onclick="hideHabitForm()">取消</button>
        </div>
      </div>
      <!-- 补录日期弹窗 -->
      <div id="date-modal" class="date-modal">
        <div class="date-modal-content">
          <div style="font-size:1.05em;margin-bottom:8px;">选择补录日期</div>
          <input id="date-input" type="date">
          <button class="btn" onclick="confirmDateModal()">补录</button>
          <button class="btn btn-small" onclick="hideDateModal()">取消</button>
        </div>
      </div>
      <button class="btn add-task-btn" style="margin-top:16px;" onclick="showHabitForm()">+ 新建习惯</button>
    </div>
  </div>
  <script>
    // ====== 密码功能 ======
    const SITE_PASSWORD = 'ganyuwindrso72'; // 你可以自定义密码
    let tasks = [];
    let habits = [];
    let timers = {};
    let dateModalHabitId = null;
    function saveTasks() { localStorage.setItem('tasks', JSON.stringify(tasks)); }
    function saveHabits() { localStorage.setItem('habits', JSON.stringify(habits)); }
    function formatTime(sec) {
      const h = Math.floor(sec/3600);
      const m = Math.floor((sec%3600)/60);
      const s = sec%60;
      return `${h>0?h+':':''}${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }
    function getTodayStr() {
      const d = new Date();
      return d.toISOString().slice(0,10);
    }
    // 递归统计所有子任务的累计时长
    function getTotalTimeSpent(subtasks) {
      let total = 0;
      for (let s of subtasks) {
        if (s.subtasks && s.subtasks.length>0) {
          total += getTotalTimeSpent(s.subtasks);
        }
        total += s.timeSpent||0;
      }
      return total;
    }
    // 任务相关
    function showTaskForm() {
      document.getElementById('task-form-modal').style.display = 'flex';
    }
    function hideTaskForm() {
      document.getElementById('task-form-modal').style.display = 'none';
      document.getElementById('task-title-input').value = '';
      document.getElementById('task-estimate-input').value = '';
    }
    function addTask() {
      const title = document.getElementById('task-title-input').value.trim();
      const estimate = Number(document.getElementById('task-estimate-input').value);
      if (!title) return alert('请输入任务名称');
      tasks.push({
        id: 'task_'+Date.now(),
        title,
        estimate: estimate||0,
        subtasks: [],
        timeSpent: 0
      });
      saveTasks();
      tasks = JSON.parse(localStorage.getItem('tasks')||'[]');
      hideTaskForm();
      renderTasks();
    }
    function addSubtask(taskId, parentId, level) {
      const name = prompt('子任务名称：');
      if (!name) return;
      let task = tasks.find(t=>t.id===taskId);
      let parent = task;
      if (parentId) {
        function findSub(subs, id) {
          for (let s of subs) {
            if (s.id===id) return s;
            if (s.subtasks) {
              const found = findSub(s.subtasks, id);
              if (found) return found;
            }
          }
        }
        parent = findSub(task.subtasks, parentId);
      }
      if (!parent.subtasks) parent.subtasks = [];
      if (level>=3) return alert('最多三级分解');
      parent.subtasks.push({
        id: 'sub_'+Date.now()+Math.random(),
        name,
        subtasks: [],
        timeSpent: 0,
        running: false,
        done: false
      });
      saveTasks();
      tasks = JSON.parse(localStorage.getItem('tasks')||'[]');
      renderTasks();
    }
    function findSubtaskById(subtasks, id) {
      for (let s of subtasks) {
        if (s.id===id) return s;
        if (s.subtasks) {
          const found = findSubtaskById(s.subtasks, id);
          if (found) return found;
        }
      }
    }
    function startTimer(taskId, subId) {
      let task = tasks.find(t=>t.id===taskId);
      let sub = findSubtaskById(task.subtasks, subId);
      if (sub.running) return;
      sub.running = true;
      if (!timers[subId]) {
        timers[subId] = setInterval(()=>{
          sub.timeSpent = (sub.timeSpent||0)+1;
          saveTasks();
          tasks = JSON.parse(localStorage.getItem('tasks')||'[]');
          renderTasks();
        }, 1000);
      }
      saveTasks();
      tasks = JSON.parse(localStorage.getItem('tasks')||'[]');
      renderTasks();
    }
    function stopTimer(taskId, subId) {
      let task = tasks.find(t=>t.id===taskId);
      let sub = findSubtaskById(task.subtasks, subId);
      if (!sub.running) return;
      sub.running = false;
      if (timers[subId]) {
        clearInterval(timers[subId]);
        timers[subId] = null;
      }
      saveTasks();
      tasks = JSON.parse(localStorage.getItem('tasks')||'[]');
      renderTasks();
    }
    function markDone(taskId, subId) {
      let task = tasks.find(t=>t.id===taskId);
      let sub = findSubtaskById(task.subtasks, subId);
      sub.done = true;
      sub.running = false;
      if (timers[subId]) {
        clearInterval(timers[subId]);
        timers[subId] = null;
      }
      saveTasks();
      tasks = JSON.parse(localStorage.getItem('tasks')||'[]');
      renderTasks();
    }
    function renderTasks() {
      tasks = JSON.parse(localStorage.getItem('tasks')||'[]');
      const board = document.getElementById('task-board');
      board.innerHTML = '';
      tasks.forEach(task => {
        // 统计进度
        let totalLeaf = 0, doneLeaf = 0;
        function countLeafs(subs) {
          let count = 0;
          for (let s of subs) {
            if (s.subtasks && s.subtasks.length>0) {
              count += countLeafs(s.subtasks);
            } else {
              count++;
              if (s.done) doneLeaf++;
            }
          }
          return count;
        }
        totalLeaf = countLeafs(task.subtasks);
        let percent = totalLeaf?Math.round(doneLeaf/totalLeaf*100):0;
        // 统计总用时（包括所有子任务）
        let totalTimeSpent = getTotalTimeSpent(task.subtasks);
        totalTimeSpent += task.timeSpent||0;
        const card = document.createElement('div');
        card.className = 'task-card';
        card.innerHTML = `
          <div class="task-title">${task.title}</div>
          <div class="task-meta">预计用时: ${task.estimate||'-'} 小时 | 已用: ${formatTime(totalTimeSpent)}</div>
          <div class="progress-bar"><div class="progress-bar-inner" style="width:${percent}%;"></div></div>
          <div style="font-size:0.95em;">完成度: ${percent}%</div>
          <ul class="subtasks"></ul>
          <button class="btn btn-small" onclick="addSubtask('${task.id}',null,1)">+ 添加一级子任务</button>
        `;
        function renderSubtasks(ul, subs, level, parentTaskId) {
          subs.forEach(sub => {
            const li = document.createElement('li');
            li.className = `subtask subtask-level-${level}`;
            let leaf = (!sub.subtasks || sub.subtasks.length===0);
            // 统计该子任务的总用时（含所有子孙）
            let subTotalTime = getTotalTimeSpent(sub.subtasks||[])+(sub.timeSpent||0);
            li.innerHTML = `
              <span style="${sub.done?'text-decoration:line-through;color:#aaa;':''}">${sub.name}</span>
              ${leaf?`<span style='color:#888;font-size:0.9em;'> | 已用: ${formatTime(subTotalTime)}</span>`:''}
              <div class="subtask-controls">
                ${level<3?`<button class='btn btn-small' onclick=\"addSubtask('${task.id}','${sub.id}',${level+1})\">+ 子任务</button>`:''}
                ${leaf?`
                  <button class='btn btn-small' onclick=\"startTimer('${task.id}','${sub.id}')\" ${sub.running?'disabled':''}>开始</button>
                  <button class='btn btn-small' onclick=\"stopTimer('${task.id}','${sub.id}')\" ${!sub.running?'disabled':''}>结束</button>
                  <button class='btn btn-small' onclick=\"markDone('${task.id}','${sub.id}')\" ${sub.done?'disabled':''}>完成</button>
                `:''}
              </div>
            `;
            ul.appendChild(li);
            if (sub.subtasks && sub.subtasks.length>0) {
              const subUl = document.createElement('ul');
              subUl.className = 'subtasks';
              renderSubtasks(subUl, sub.subtasks, level+1, parentTaskId);
              ul.appendChild(subUl);
            }
          });
        }
        renderSubtasks(card.querySelector('.subtasks'), task.subtasks, 1, task.id);
        board.appendChild(card);
      });
    }
    // 习惯相关
    function showHabitForm() {
      document.getElementById('habit-form-modal').style.display = 'flex';
    }
    function hideHabitForm() {
      document.getElementById('habit-form-modal').style.display = 'none';
      document.getElementById('habit-title-input').value = '';
    }
    function addHabit() {
      const title = document.getElementById('habit-title-input').value.trim();
      if (!title) return alert('请输入习惯名称');
      habits.push({
        id: 'habit_'+Date.now(),
        title,
        days: {} // {date: true}
      });
      saveHabits();
      habits = JSON.parse(localStorage.getItem('habits')||'[]');
      hideHabitForm();
      renderHabits();
    }
    function toggleHabitDone(habitId, dateStr) {
      const habit = habits.find(h=>h.id===habitId);
      if (!habit.days) habit.days = {};
      habit.days[dateStr] = !habit.days[dateStr];
      saveHabits();
      habits = JSON.parse(localStorage.getItem('habits')||'[]');
      renderHabits();
    }
    // 补录日期弹窗
    function showDateModal(habitId) {
      dateModalHabitId = habitId;
      document.getElementById('date-modal').style.display = 'flex';
      document.getElementById('date-input').value = '';
    }
    function hideDateModal() {
      document.getElementById('date-modal').style.display = 'none';
      dateModalHabitId = null;
    }
    function confirmDateModal() {
      const dateStr = document.getElementById('date-input').value;
      if (!dateStr) return alert('请选择日期');
      const habit = habits.find(h=>h.id===dateModalHabitId);
      if (!habit.days) habit.days = {};
      habit.days[dateStr] = true;
      saveHabits();
      habits = JSON.parse(localStorage.getItem('habits')||'[]');
      hideDateModal();
      renderHabits();
    }
    function renderHabits() {
      habits = JSON.parse(localStorage.getItem('habits')||'[]');
      const board = document.getElementById('habit-board');
      board.innerHTML = '';
      habits.forEach(habit => {
        const card = document.createElement('div');
        card.className = 'habit-card';
        card.innerHTML = `<div class='habit-label'>${habit.title}</div>`;
        // 控件
        const controls = document.createElement('div');
        controls.className = 'habit-controls';
        controls.innerHTML = `
          <button class='btn btn-small' onclick="toggleHabitDone('${habit.id}','${getTodayStr()}')">今日打卡</button>
          <button class='btn btn-small' onclick="showDateModal('${habit.id}')">补录打卡</button>
        `;
        card.appendChild(controls);
        // 生成最近一年的日期（按周排列）
        const today = new Date();
        let days = [];
        let start = new Date(today.getFullYear(),0,1);
        for (let i=0;i<366;i++) {
          let d = new Date(start.getTime()+i*24*3600*1000);
          if (d>today) break;
          days.push(d.toISOString().slice(0,10));
        }
        // 补足到53周
        while (days.length<53*7) days.push('');
        // 热力图
        const heatmap = document.createElement('div');
        heatmap.className = 'heatmap';
        for (let col=0;col<53;col++) {
          for (let row=0;row<7;row++) {
            let idx = row+col*7;
            let dateStr = days[idx];
            const dayDiv = document.createElement('div');
            dayDiv.className = 'heatmap-day'+(dateStr&&habit.days[dateStr]?' done':'');
            dayDiv.title = dateStr||'';
            if (dateStr) dayDiv.onclick = ()=>toggleHabitDone(habit.id, dateStr);
            heatmap.appendChild(dayDiv);
          }
        }
        card.appendChild(heatmap);
        // 标签
        const labels = document.createElement('div');
        labels.className = 'heatmap-labels';
        labels.innerHTML = '<span>1月</span><span>12月</span>';
        card.appendChild(labels);
        board.appendChild(card);
      });
    }
    // 页面初始化和密码校验
    window.onload = function() {
      if (localStorage.getItem('site_authed') === '1') {
        document.getElementById('main-app').style.display = '';
        tasks = JSON.parse(localStorage.getItem('tasks')||'[]');
        habits = JSON.parse(localStorage.getItem('habits')||'[]');
        renderTasks();
        renderHabits();
      } else {
        showPasswordModal();
      }
    }
  </script>
</body>
</html>
